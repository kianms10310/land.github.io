<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부동산 가격 비교 - 관리자 모드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; letter-spacing: -0.025em; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: bold; background: #eff6ff; }
        .tabs-container { -ms-overflow-style: none; scrollbar-width: none; scroll-behavior: smooth; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .edit-input { width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px; font-size: 0.75rem; outline-color: #3b82f6; transition: all 0.2s; }
        .edit-input:focus { background-color: #fff; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .edit-input:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; border-color: #e2e8f0; }
        /* 모달 스타일 */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-10">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">부동산 가격 비교</h1>
                <p class="text-slate-500 mt-1 italic">실거래가(계약일) vs 호가(등록일) 추이 비교</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="save-btn" onclick="saveToGithub()" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm font-bold shadow-md transition-all"><i class="fas fa-save mr-1"></i> 저장</button>
                <button onclick="toggleEditMode()" class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded-full text-sm font-bold shadow-md transition-all"><i class="fas fa-lock mr-1"></i> <span id="edit-btn-text">관리자</span></button>
                <div id="data-count" class="hidden md:block text-sm font-medium text-slate-400 bg-white px-4 py-2 rounded-full shadow-sm border border-slate-100"></div>
            </div>
        </header>

        <div id="tabs-wrapper" class="tabs-container flex overflow-x-auto whitespace-nowrap mb-6 bg-white rounded-xl shadow-sm border border-slate-200"></div>

        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-slate-700"><i class="fas fa-chart-line mr-2 text-blue-500"></i>가격 변동 추이</h2>
                <div id="size-filters" class="flex gap-2"></div>
            </div>
            <div class="h-[300px]"><canvas id="priceChart"></canvas></div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
            <div id="admin-controls" class="hidden p-4 bg-slate-50 border-b flex justify-end">
                <button onclick="addNewData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm"><i class="fas fa-plus mr-1"></i> 새 데이터 추가</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-800 text-white text-xs uppercase tracking-wider">
                            <th class="px-4 py-4 font-semibold">등록/계약</th>
                            <th class="px-4 py-4 font-semibold text-center">입주일</th>
                            <th class="px-4 py-4 font-semibold text-center">상태</th>
                            <th class="px-4 py-4 font-semibold text-right">실거래가</th>
                            <th class="px-4 py-4 font-semibold text-right">호가(이력)</th>
                            <th class="px-4 py-4 font-semibold text-center">동/층</th>
                            <th class="px-4 py-4 font-semibold">특이사항</th>
                            <th id="th-action" class="hidden px-4 py-4 font-semibold text-center">관리</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold">호가 변경 이력 관리</h3>
                <button onclick="closeHistoryModal()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div id="history-list" class="space-y-3 max-h-60 overflow-y-auto mb-4"></div>
                <div class="grid grid-cols-2 gap-2 p-3 bg-slate-50 rounded-lg">
                    <input id="new-hist-date" type="date" class="edit-input">
                    <input id="new-hist-price" type="number" step="0.01" class="edit-input" placeholder="호가">
                    <button onclick="addHistoryItem()" class="col-span-2 bg-blue-600 text-white py-2 rounded-lg text-xs font-bold mt-2 hover:bg-blue-700">+ 이력 직접 추가</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수 및 설정 (기존과 동일)
        const tabsConfig = [
            { id: 'sinjung7', name: '신정마을7단지', file: './data/sinjung7.json' }
            // ... 다른 단지들
        ];
        const ADMIN_HASH = "90eae63487cae2df5b793b07c622680d2df6c9a024891c8a9bd98d08d5bc3d92";
        let isEditMode = false, ghToken = "", priceChart = null, currentRawData = [], filteredData = [], currentSize = null, currentEditingIdx = null;

        window.onload = () => { initTabs(); handleTabClick(tabsConfig[0].file, tabsConfig[0].id); };

        // --- 이력 관리 핵심 함수 ---
        function openHistoryModal(idx) {
            currentEditingIdx = idx;
            const item = filteredData[idx];
            if (!item.priceHistory) item.priceHistory = [];
            renderHistoryList();
            document.getElementById('history-modal').classList.add('active');
        }

        function closeHistoryModal() { document.getElementById('history-modal').classList.remove('active'); }

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            const history = filteredData[currentEditingIdx].priceHistory;
            if (history.length === 0) {
                list.innerHTML = `<p class="text-center text-slate-400 text-xs py-4">저장된 이력이 없습니다.</p>`;
                return;
            }
            list.innerHTML = history.map((h, i) => `
                <div class="flex justify-between items-center bg-white border border-slate-200 p-2 rounded-lg">
                    <span class="text-xs font-mono font-bold text-slate-600">${h.date}</span>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold text-blue-600">${h.price.toFixed(2)}</span>
                        <button onclick="deleteHistoryItem(${i})" class="text-red-300 hover:text-red-500 text-xs"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function addHistoryItem() {
            const date = document.getElementById('new-hist-date').value;
            const price = parseFloat(document.getElementById('new-hist-price').value);
            if (!date || isNaN(price)) return alert("날짜와 가격을 입력하세요.");
            
            filteredData[currentEditingIdx].priceHistory.push({ date, price });
            filteredData[currentEditingIdx].priceHistory.sort((a,b) => new Date(a.date) - new Date(b.date));
            renderHistoryList();
            renderTable();
        }

        function deleteHistoryItem(i) {
            if (confirm("이 이력을 삭제할까요?")) {
                filteredData[currentEditingIdx].priceHistory.splice(i, 1);
                renderHistoryList();
                renderTable();
            }
        }

        // --- 기존 데이터 관리 함수 (호가 수정 시 자동 이력 추가 로직 포함) ---
        function updateDataValue(index, key, value) {
            const item = filteredData[index];
            if (key === 'askingPrice') {
                const newPrice = value === "" ? null : parseFloat(value);
                const today = new Date().toISOString().split('T')[0];
                if (item.askingPrice !== null && item.askingPrice !== newPrice) {
                    if (!item.priceHistory) item.priceHistory = [];
                    // 중복 방지: 같은 날짜의 이력이 있으면 가격만 업데이트, 없으면 추가
                    const existingIdx = item.priceHistory.findIndex(h => h.date === today);
                    if (existingIdx > -1) item.priceHistory[existingIdx].price = item.askingPrice;
                    else item.priceHistory.push({ date: today, price: item.askingPrice });
                    item.priceHistory.sort((a,b) => new Date(a.date) - new Date(b.date));
                }
                item.askingPrice = newPrice;
            } else if (['actualPrice', 'size'].includes(key)) {
                item[key] = value === "" ? null : parseFloat(value);
            } else { item[key] = value; }
            renderTable(); renderChart();
        }

        // --- 렌더링 및 기타 로직 (통합본 유지) ---
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = filteredData.map((item, realIdx) => {
                const hasActual = item.actualPrice && item.actualPrice > 0;
                const hasContract = item.contractDate && item.contractDate.trim() !== "";
                const status = (hasActual && hasContract) ? "완료" : (item.isInProgress ? "진행 중" : "시작 전");
                const isReadonly = item.isLocked || status === "완료";
                const disabledAttr = isReadonly ? "disabled" : "";

                if (isEditMode) {
                    return `
                    <tr class="${isReadonly ? 'bg-slate-100/60' : 'bg-white'}">
                        <td class="px-2 py-2 flex flex-col gap-1">
                            <input class="edit-input font-bold" type="text" value="${item.regDate}" onchange="updateDataValue(${realIdx}, 'regDate', this.value)" ${disabledAttr}>
                            <input class="edit-input text-[10px]" type="text" value="${item.contractDate || ''}" onchange="updateDataValue(${realIdx}, 'contractDate', this.value)" ${disabledAttr} placeholder="계약일">
                        </td>
                        <td class="px-2 py-2"><input class="edit-input text-center" type="text" value="${item.moveInDate || ''}" onchange="updateDataValue(${realIdx}, 'moveInDate', this.value)" ${disabledAttr} placeholder="입주일"></td>
                        <td class="px-2 py-2 text-center text-[10px] font-bold">${status}</td>
                        <td class="px-2 py-2"><input class="edit-input text-right text-red-600 font-bold" type="number" step="0.01" value="${item.actualPrice || ''}" onchange="updateDataValue(${realIdx}, 'actualPrice', this.value)" ${disabledAttr}></td>
                        <td class="px-2 py-2">
                            <div class="flex gap-1 items-center">
                                <input class="edit-input text-right text-blue-600 font-bold" type="number" step="0.01" value="${item.askingPrice || ''}" onchange="updateDataValue(${realIdx}, 'askingPrice', this.value)" ${disabledAttr}>
                                <button onclick="openHistoryModal(${realIdx})" class="p-2 text-slate-400 hover:text-blue-500"><i class="fas fa-history"></i></button>
                            </div>
                        </td>
                        <td class="px-2 py-2">
                            <input class="edit-input mb-1 text-center" type="text" value="${item.building}" onchange="updateDataValue(${realIdx}, 'building', this.value)" ${disabledAttr} placeholder="동">
                            <input class="edit-input text-center" type="text" value="${item.floor}" onchange="updateDataValue(${realIdx}, 'floor', this.value)" ${disabledAttr} placeholder="층">
                        </td>
                        <td class="px-2 py-2"><textarea class="edit-input" onchange="updateDataValue(${realIdx}, 'note', this.value)" ${disabledAttr}>${item.note || ''}</textarea></td>
                        <td class="px-2 py-2 text-center">
                            <button onclick="deleteData(${realIdx})" class="text-red-300 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }
                // (일반 모드는 이전 코드와 동일하여 생략 가능하지만 구조 유지)
                return `<tr class="hover:bg-slate-50">
                    <td class="px-4 py-4 font-bold">${item.regDate}<br><span class="text-[10px] text-slate-400 font-normal">${item.contractDate || '-'}</span></td>
                    <td class="px-4 py-4 text-center text-xs text-slate-500">${item.moveInDate || '-'}</td>
                    <td class="px-4 py-4 text-center"><span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100">${status}</span></td>
                    <td class="px-4 py-4 text-right font-mono font-bold text-red-600">${item.actualPrice || '-'}</td>
                    <td class="px-4 py-4 text-right">
                        <div class="font-mono font-bold text-blue-600">${item.askingPrice || '-'}</div>
                        <div class="text-[9px] text-slate-400 mt-1">${item.priceHistory?.slice(-1).map(h => `p: ${h.price} (${h.date.slice(5)})`).join('') || ''}</div>
                    </td>
                    <td class="px-4 py-4 text-center text-xs">${item.building}동 / ${item.floor}층</td>
                    <td class="px-4 py-4 text-xs italic text-slate-500">${item.note || ''}</td>
                </tr>`;
            }).join('');
        }

        // 나머지 공통 함수들(initTabs, handleTabClick, loadData, renderChart 등)은 이전 통합본과 동일하게 유지
        function initTabs() {
            const wrapper = document.getElementById('tabs-wrapper');
            wrapper.innerHTML = tabsConfig.map(tab => `
                <button id="btn-${tab.id}" onclick="handleTabClick('${tab.file}', '${tab.id}')" 
                        class="tab-btn px-6 py-4 text-slate-500 hover:text-blue-600 border-b-2 border-transparent transition-all shrink-0">
                    ${tab.name}
                </button>
            `).join('');
        }

        async function handleTabClick(file, id) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
            const btn = document.getElementById(`btn-${id}`);
            if(btn) btn.classList.add('tab-active');
            await loadData(file, id);
        }

        async function loadData(fileName, id) {
            try {
                const response = await fetch(fileName + '?v=' + Date.now());
                currentRawData = await response.json();
                const sizes = [...new Set(currentRawData.map(item => item.size))].sort((a, b) => a - b);
                renderSizeFilters(sizes);
                updateView(currentSize || sizes[0]);
            } catch (e) { console.error(e); }
        }

        function renderSizeFilters(sizes) {
            const container = document.getElementById('size-filters');
            container.innerHTML = sizes.map(size => `
                <button onclick="updateView(${size})" class="size-btn px-4 py-1.5 rounded-full border border-slate-200 text-xs font-bold transition-all hover:bg-slate-50">전용 ${size}㎡</button>
            `).join('');
        }

        function updateView(size) {
            currentSize = size;
            filteredData = currentRawData.filter(item => item.size === size);
            document.getElementById('data-count').innerText = `총 ${filteredData.length}건`;
            renderChart(); renderTable();
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function toggleEditMode() {
            if (isEditMode) { location.reload(); return; }
            const pwd = prompt("비밀번호:");
            if (await sha256(pwd) === ADMIN_HASH) {
                ghToken = prompt("GitHub Token:");
                isEditMode = true;
                document.getElementById('save-btn').classList.remove('hidden');
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('th-action').classList.remove('hidden');
                renderTable();
            }
        }
        
        function addNewData() {
            const today = new Date().toISOString().split('T')[0];
            currentRawData.unshift({
                regDate: today, contractDate: "", moveInDate: "",
                actualPrice: null, askingPrice: null,
                building: "", floor: "", size: currentSize,
                note: "", isLocked: false, isInProgress: false, priceHistory: []
            });
            updateView(currentSize);
        }

        function renderChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            const actual = filteredData.filter(d => d.actualPrice && (d.contractDate || d.regDate)).map(d => ({ x: d.contractDate || d.regDate, y: d.actualPrice })).sort((a, b) => new Date(a.x) - new Date(b.x));
            const asking = filteredData.filter(d => d.askingPrice && d.regDate).map(d => ({ x: d.regDate, y: d.askingPrice })).sort((a, b) => new Date(a.x) - new Date(b.x));
            if (priceChart) priceChart.destroy();
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        { label: '실거래가', data: actual, borderColor: '#2563eb', tension: 0.1, pointRadius: 4 },
                        { label: '호가', data: asking, borderColor: '#ea580c', borderDash: [5, 5], tension: 0.1, pointRadius: 4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time' } } }
            });
        }
    </script>
</body>
</html>
