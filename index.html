let priceChart = null;
let currentData = [];

async function loadData(fileName) {
    try {
        const response = await fetch(fileName);
        currentData = await response.json();
        
        // 1. 해당 아파트에 존재하는 면적(size) 목록 추출
        const sizes = [...new Set(currentData.map(item => item.size))].sort((a, b) => a - b);
        renderSizeFilters(sizes);
        
        // 2. 기본으로 첫 번째 면적 데이터 표시
        updateView(sizes[0]);
    } catch (error) {
        console.error('데이터 로드 실패:', error);
    }
}

function renderSizeFilters(sizes) {
    const filterContainer = document.getElementById('size-filters');
    filterContainer.innerHTML = sizes.map(size => `
        <button onclick="updateView(${size})" class="size-btn px-4 py-2 rounded-lg border border-slate-200 text-sm font-medium hover:bg-blue-50 transition">
            전용 ${size}㎡
        </button>
    `).join('');
}

function updateView(selectedSize) {
    // 버튼 스타일 업데이트
    document.querySelectorAll('.size-btn').forEach(btn => {
        btn.classList.toggle('bg-blue-600', btn.innerText.includes(selectedSize));
        btn.classList.toggle('text-white', btn.innerText.includes(selectedSize));
    });

    const filteredData = currentData.filter(item => item.size === selectedSize);
    renderTable(filteredData);
    renderChart(filteredData, selectedSize);
}

function renderChart(data, size) {
    const ctx = document.getElementById('priceChart').getContext('2d');
    
    // 실거래가: 계약일 기준 정렬
    const actualData = data
        .filter(d => d.actualPrice && d.contractDate)
        .map(d => ({ x: d.contractDate, y: d.actualPrice }))
        .sort((a, b) => new Date(a.x) - new Date(b.x));

    // 호가: 등록일 기준 정렬
    const askingData = data
        .filter(d => d.askingPrice && d.regDate)
        .map(d => ({ x: d.regDate, y: d.askingPrice }))
        .sort((a, b) => new Date(a.x) - new Date(b.x));

    if (priceChart) priceChart.destroy();

    priceChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: `${size}㎡ 실거래가`,
                    data: actualData,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                },
                {
                    label: `${size}㎡ 호가`,
                    data: askingData,
                    borderColor: '#ea580c',
                    borderDash: [5, 5],
                    backgroundColor: 'transparent',
                    tension: 0.2,
                    pointRadius: 6,
                    pointStyle: 'rectRot'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (ctx) => ` ${ctx.dataset.label}: ${ctx.raw.y}억 (${ctx.raw.x})`
                    }
                }
            },
            scales: {
                x: { 
                    type: 'time', 
                    time: { unit: 'month', displayFormats: { month: 'YY년 MM월' } },
                    title: { display: true, text: '기준일 (계약/등록)' }
                },
                y: { 
                    beginAtZero: false,
                    title: { display: true, text: '가격 (단위: 억)' } 
                }
            }
